name: 03 更新 Scoop Manifest

on:
  workflow_run:
    workflows: ["02 构建发行"]
    types: [completed]

  release:
    types: [published]

  workflow_dispatch:
    inputs:
      version_tag:
        description: "Release 版本号 (空则取最新)"
        required: false
        type: string
      is_prerelease:
        description: "是否为 Pre-release"
        required: false
        default: "false"
        type: string

permissions:
  contents: write

jobs:
  update-bucket:
    runs-on: ubuntu-latest
    if: >-
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'release' ||
      github.event.workflow_run.conclusion == 'success'
    steps:
      - name: 确定目标版本号
        run: |
          if [ -n "${{ inputs.version_tag }}" ]; then
            echo "手动指定版本: ${{ inputs.version_tag }}"
            echo "TARGET_TAG=${{ inputs.version_tag }}" >> $GITHUB_ENV
          elif [ -n "${{ github.event.release.tag_name }}" ]; then
            echo "Release 事件: ${{ github.event.release.tag_name }}"
            echo "TARGET_TAG=${{ github.event.release.tag_name }}" >> $GITHUB_ENV
          else
            TAG=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r .tag_name)
            echo "自动获取最新: $TAG"
            echo "TARGET_TAG=$TAG" >> $GITHUB_ENV
          fi

      - name: 判断是否为 Pre-release
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            IS_PRE="${{ inputs.is_prerelease }}"
          elif [ "${{ github.event_name }}" = "release" ]; then
            IS_PRE="${{ github.event.release.prerelease }}"
          else
            IS_PRE=$(curl -s "https://api.github.com/repos/${{ github.repository }}/releases/tags/$TARGET_TAG" | jq -r '.prerelease // false')
          fi
          echo "IS_PRERELEASE=$IS_PRE" >> $GITHUB_ENV
          echo "Pre-release: $IS_PRE"

      - name: 等待并获取 Windows 产物信息
        run: |
          TAG="$TARGET_TAG"
          for i in $(seq 1 20); do
            URL=$(curl -s "https://api.github.com/repos/${{ github.repository }}/releases/tags/$TAG" \
              | jq -r '.assets[] | select(.name | test("windows.*\\.zip")) | .browser_download_url' \
              | head -1)
            if [ -n "$URL" ] && [ "$URL" != "null" ]; then
              echo "找到产物: $URL"
              echo "ASSET_URL=$URL" >> $GITHUB_ENV
              break
            fi
            echo "[$i/20] 产物未就绪，等待 15s..."
            sleep 15
          done
          if [ -z "$URL" ] || [ "$URL" = "null" ]; then
            echo "::error::未找到 Windows 产物"
            exit 1
          fi

      - name: 下载并计算 Hash
        run: |
          curl -L -o zed-windows.zip "$ASSET_URL"
          HASH=$(sha256sum zed-windows.zip | awk '{print $1}')
          echo "SHA256=$HASH" >> $GITHUB_ENV
          rm zed-windows.zip

      - name: 生成 Manifest
        run: |
          VERSION="$TARGET_TAG"
          CLEAN_VERSION="${VERSION#v}"
          REPO="${{ github.repository }}"

          generate_manifest() {
            local name="$1"
            local out="$2"
            cat > "$out" << MANIFEST
          {
              "version": "$CLEAN_VERSION",
              "description": "Zed Editor (Localized / 汉化版)${3:+ - Preview}",
              "homepage": "https://github.com/$REPO",
              "license": "GPL-3.0-only",
              "architecture": {
                  "64bit": {
                      "url": "$ASSET_URL",
                      "hash": "$SHA256"
                  }
              },
              "bin": "ZedG.exe",
              "shortcuts": [["ZedG.exe", "ZedG"]],
              "checkver": {
                  "github": "https://github.com/$REPO"
              },
              "autoupdate": {
                  "architecture": {
                      "64bit": {
                          "url": "https://github.com/$REPO/releases/download/v\$version/zed-windows.zip"
                      }
                  }
              }
          }
          MANIFEST
          }

          if [ "$IS_PRERELEASE" = "true" ]; then
            echo "生成预览版 Manifest"
            generate_manifest "zedg-preview" "zedg-preview.json" "preview"
          else
            echo "生成稳定版 Manifest"
            generate_manifest "zedg" "zedg.json"
          fi

      - name: 推送 Manifest 到 scoop 分支
        run: |
          VERSION="$TARGET_TAG"
          CLEAN_VERSION="${VERSION#v}"

          git init /tmp/scoop-branch
          cd /tmp/scoop-branch
          git remote add origin "https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git"

          if git ls-remote --heads origin scoop | grep -q scoop; then
            git fetch origin scoop --depth 1
            git checkout scoop
          else
            git checkout -b scoop
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 清理旧包名文件（从 zed-globalization 迁移到 zedg）
          if [ -f zed-globalization.json ]; then
            git rm zed-globalization.json
          fi
          if [ -f zed-globalization-preview.json ]; then
            git rm zed-globalization-preview.json
          fi

          if [ "$IS_PRERELEASE" = "true" ]; then
            # Pre-release: 仅更新预览版
            cp $GITHUB_WORKSPACE/zedg-preview.json .
            git add zedg-preview.json
            git diff --cached --quiet || git commit -m "chore(scoop): 预览版更新到 $VERSION"
          else
            # Stable release: 更新稳定版
            cp $GITHUB_WORKSPACE/zedg.json .
            git add zedg.json

            # 如果稳定版比预览版更新，同步更新预览版
            PREVIEW_VER=""
            if [ -f zedg-preview.json ]; then
              PREVIEW_VER=$(jq -r '.version' zedg-preview.json)
            fi

            if [ -z "$PREVIEW_VER" ] || \
               [ "$(printf '%s\n' "$CLEAN_VERSION" "$PREVIEW_VER" | sort -V | tail -1)" = "$CLEAN_VERSION" ] && \
               [ "$CLEAN_VERSION" != "$PREVIEW_VER" ]; then
              echo "稳定版 ($CLEAN_VERSION) 比预览版 ($PREVIEW_VER) 更新，同步更新预览版"
              cp $GITHUB_WORKSPACE/zedg.json zedg-preview.json
              # 修正 description 字段
              jq '.description = "Zed Editor (Localized / 汉化版) - Preview"' zedg-preview.json > /tmp/preview.json
              mv /tmp/preview.json zedg-preview.json
              git add zedg-preview.json
            fi

            git diff --cached --quiet || git commit -m "chore(scoop): 更新到 $VERSION"
          fi

          git push origin scoop
