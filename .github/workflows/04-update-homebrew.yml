name: 04 更新 Homebrew Cask

on:
  workflow_run:
    workflows: ["02 构建发行"]
    types: [completed]

  release:
    types: [published]

  workflow_dispatch:
    inputs:
      version_tag:
        description: "Release 版本号 (空则取最新)"
        required: false
        type: string

permissions:
  contents: read

env:
  TAP_REPO: x6nux/homebrew-zedg

jobs:
  update-cask:
    runs-on: ubuntu-latest
    if: >-
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'release' ||
      github.event.workflow_run.conclusion == 'success'
    steps:
      - name: 确定目标版本号
        run: |
          if [ -n "${{ inputs.version_tag }}" ]; then
            echo "手动指定版本: ${{ inputs.version_tag }}"
            echo "TARGET_TAG=${{ inputs.version_tag }}" >> $GITHUB_ENV
          elif [ -n "${{ github.event.release.tag_name }}" ]; then
            echo "Release 事件: ${{ github.event.release.tag_name }}"
            echo "TARGET_TAG=${{ github.event.release.tag_name }}" >> $GITHUB_ENV
          else
            TAG=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r .tag_name)
            echo "自动获取最新: $TAG"
            echo "TARGET_TAG=$TAG" >> $GITHUB_ENV
          fi

      - name: 等待并获取 macOS 产物信息
        run: |
          TAG="$TARGET_TAG"
          for i in $(seq 1 20); do
            URL=$(curl -s "https://api.github.com/repos/${{ github.repository }}/releases/tags/$TAG" \
              | jq -r '.assets[] | select(.name | test("macos.*\\.dmg")) | .browser_download_url' \
              | head -1)
            if [ -n "$URL" ] && [ "$URL" != "null" ]; then
              echo "找到产物: $URL"
              echo "ASSET_URL=$URL" >> $GITHUB_ENV
              break
            fi
            echo "[$i/20] 产物未就绪，等待 15s..."
            sleep 15
          done
          if [ -z "$URL" ] || [ "$URL" = "null" ]; then
            echo "::error::未找到 macOS DMG 产物"
            exit 1
          fi

      - name: 下载并计算 Hash
        run: |
          curl -L -o zedg-macos.dmg "$ASSET_URL"
          HASH=$(sha256sum zedg-macos.dmg | awk '{print $1}')
          echo "SHA256=$HASH" >> $GITHUB_ENV
          echo "SHA256: $HASH"
          rm zedg-macos.dmg

      - name: 生成 Homebrew Cask
        run: |
          CLEAN_VERSION="${TARGET_TAG#v}"
          REPO="${{ github.repository }}"

          mkdir -p Casks
          cat > Casks/zedg.rb <<CASK
          cask "zedg" do
            version "$CLEAN_VERSION"
            sha256 "$SHA256"

            url "$ASSET_URL"
            name "ZedG"
            desc "Zed Editor (Localized / 汉化版)"
            homepage "https://github.com/$REPO"

            depends_on macos: ">= :ventura"

            app "ZedG.app"

            postflight do
              system_command "/usr/bin/xattr",
                             args: ["-rd", "com.apple.quarantine", "#{appdir}/ZedG.app"]
            end

            zap trash: [
              "~/Library/Application Support/Zed",
              "~/Library/Caches/dev.zed.ZedG",
              "~/Library/Preferences/dev.zed.ZedG.plist",
            ]
          end
          CASK

      - name: 推送到 tap 仓库
        env:
          TAP_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          VERSION="$TARGET_TAG"

          git clone "https://x-access-token:${TAP_TOKEN}@github.com/${TAP_REPO}.git" /tmp/tap
          cd /tmp/tap

          mkdir -p Casks
          cp $GITHUB_WORKSPACE/Casks/zedg.rb Casks/
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/zedg.rb
          git diff --cached --quiet || git commit -m "chore: 更新到 $VERSION"
          git push origin main
