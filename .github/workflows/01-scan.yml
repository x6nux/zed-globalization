name: 01 扫描翻译文件

on:
  schedule:
    - cron: "0 20 * * *" # 每天北京时间 04:00
  workflow_dispatch:
    inputs:
      chain:
        description: "完成后自动触发翻译"
        type: boolean
        default: false
      lang:
        description: "目标语言"
        type: choice
        options:
          - zh-CN
          - zh-TW
          - ja
          - ko
        default: zh-CN

permissions:
  contents: write

env:
  ZED_REPO: https://github.com/zed-industries/zed.git

jobs:
  # ====== 检测 Zed 是否发布新版本 ======
  check-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.check.outputs.version }}
      has_update: ${{ steps.check.outputs.has_update }}
    steps:
      - id: check
        run: |
          UPSTREAM=$(curl -s https://api.github.com/repos/zed-industries/zed/releases/latest | jq -r .tag_name)
          LOCAL=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r .tag_name)
          echo "Zed 官方最新: $UPSTREAM | 本地最新: $LOCAL"

          # 手动触发时始终执行扫描
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "手动触发，执行扫描"
            echo "version=$UPSTREAM" >> $GITHUB_OUTPUT
            echo "has_update=true" >> $GITHUB_OUTPUT

          elif [ "$UPSTREAM" != "null" ] && [ "$UPSTREAM" != "$LOCAL" ]; then
            echo "发现新版本: $UPSTREAM"
            echo "version=$UPSTREAM" >> $GITHUB_OUTPUT
            echo "has_update=true" >> $GITHUB_OUTPUT

          else
            echo "版本一致，跳过"
            echo "has_update=false" >> $GITHUB_OUTPUT
          fi

  # ====== AI 扫描 + 字符串提取 ======
  scan:
    needs: check-version
    if: needs.check-version.outputs.has_update == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: 安装依赖
        run: pip install ".[ai]"

      - name: 克隆 Zed 源码
        run: |
          git clone --depth 1 $ZED_REPO zed
          cd zed && git checkout ${{ needs.check-version.outputs.version }} 2>/dev/null || true

      - name: AI 扫描 + 提取字符串
        env:
          AI_BASE_URL: ${{ secrets.AI_BASE_URL }}
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          AI_MODEL: ${{ secrets.AI_MODEL }}
          AI_CONCURRENCY: ${{ vars.AI_CONCURRENCY || '10' }}
        run: |
          python3 << 'PYEOF'
          from zedl10n.scan import scan_files
          from zedl10n.extract import extract_all
          from zedl10n.utils import AIConfig, setup_logging
          setup_logging()
          ai = AIConfig()
          ai.validate()
          files = scan_files("zed", ai)
          extract_all(files, "string.json", "string_context.json")
          PYEOF

      - name: 推送到 i18n 分支
        run: |
          cp string.json string_context.json /tmp/

          if git ls-remote --heads origin i18n | grep -q i18n; then
            git clone --branch i18n --single-branch --depth 1 \
              "https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git" \
              /tmp/i18n-branch
          else
            mkdir /tmp/i18n-branch && cd /tmp/i18n-branch
            git init && git checkout -b i18n
            git remote add origin "https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git"
          fi

          cp /tmp/string.json /tmp/string_context.json /tmp/i18n-branch/
          cd /tmp/i18n-branch
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add string.json string_context.json
          git diff --cached --quiet || git commit -m "feat(i18n): 更新扫描结果"
          git push origin i18n

      # 定时触发或手动+chain 时链式调用下一步
      - name: 触发翻译工作流
        if: github.event_name == 'schedule' || inputs.chain == true
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ github.event_name }}" == "schedule" ]; then
            LANG_VALUE="zh-CN"
          else
            LANG_VALUE="${{ inputs.lang }}"
          fi

          gh api repos/${{ github.repository }}/dispatches \
            -f event_type=translate-ready \
            -f "client_payload[version]=${{ needs.check-version.outputs.version }}" \
            -f "client_payload[lang]=$LANG_VALUE"
